---
title: "HMDA_project_JG"
author: "James Gilbert"
date: "12/9/2021"
output: html_document
---

```{r}
library(httr)
library(tidyverse)
#library(jsonlite)
```

```{r}
HMDA_PNW<- read_csv('data/state_WA-OR-ID-MT.csv')
```


USE THIS CODE FOR API CALL FOR PNW.
```{r}
url <- 'https://ffiec.cfpb.gov/v2/data-browser-api/view/csv?states=WA,MT,ID,OR&years=2020'

response <- GET(url)

HMDA<-content(response, as = "text") %>%
  read_csv()
```
```{r}
url_LEI <- 'https://ffiec.cfpb.gov/v2/data-browser-api/view/filers?states=WA,MT,ID,OR&years=2020'
response_PNW_LEI <- GET(url_LEI) 
lei_PNW <- content(response_PNW_LEI, type = 'text') %>% 
  jsonlite::fromJSON() %>% 
  .[[1]] %>%                      # Select the first element of the resulting list
  as_tibble()
```

Merge the LEI dataframe with the HMDA dataframe so we can correlate institution name with the LEI. 
```{r}
HMDA_PNW<- HMDA_PNW %>%
  left_join(x=HMDA_PNW, y =lei_PNW, by = 'lei')

```

```{r}
lei_PNW %>% 
  ggplot(aes(count))+
  geom_histogram(bins = 50)
```

```{r}

HMDA_PNW$Action_took <-recode(HMDA_PNW$action_taken,
             '1'= 'loan originated',
             '2'= 'application approved but not accepted',
             '3'= 'application denied',
             '4'= 'application withdrawn by applicant',
             '5'= 'file closed for incompleteness',
             '6'= 'Purchased loan',
             '7'= 'preapproval request denied',
             '8'= 'preapproval request approved but not accepted')
```

```{r}
HMDA_PNW %>% 
  select(Action_took, action_taken)
```

1, loan originated
2, application approved but not accepted
3, application denied
4, application withdrawn by applicant 
5, file closed for incompleteness
6, Purchased loan
7, preapproval request denied
8, preapproval request approved but not accepted




```{r}
lei_PNW %>% 
  select(name,count) %>% 
  top_n(5, count)
```

Merge the LEI dataframe with the HMDA dataframe so we can correlate institution name with the LEI. 


```{r}
#Code from George to add LARS lookups. Although it's not currently working for me. 
data <- read_lines("../hmda_shiny-missile-toes/data/lars_lookup (1).csv")
lars_names <- c()
options <- c()
for (i in 1:length(data)){
  if (grepl( "^1 - ", data[i],)) {
    print(data[i - 3])
    j <- 0
    while (grepl( " - ", data[i + j],)) {
      options <- c(options, data[i + j])
      lars_names <- c(lars_names, data[i - 3])
      j <- j + 1
    }
  }
}
lars_tib <- tibble(lars_names = lars_names, options = options)

```

```{r}
lars_tib <- lars_tib %>% separate(options, c("key", "value"), " - ", extra = "merge")
write_csv(lars_tib, "../hmda_shiny-missile-toes/data/lars_lookup (1).csv")
```



I want to begin exploring the data set for WA by comparing the 'protected' classes from the HMDA

```{r}
HMDA_selected<- HMDA_PNW %>% 
  select(lei, derived_ethnicity, derived_race, derived_sex, interest_rate, debt_to_income_ratio, action_taken, census_tract, tract_population, tract_minority_population_percent, applicant_age, applicant_age_above_62, name, count)
HMDA_selected
```

```{r}
HMDA_selected %>% 
  select(derived_race, action_taken, tract_population) %>% 
  filter(action_taken==1, tract_population>0) %>% 
  group_by(derived_race) %>% 
  count() %>% 
  summarise(proportion = n/tract_population)
  
  
```  



```{r}
HMDA_selected %>% 
  group_by(derived_race) %>% 
  summarise(denied = sum(action_taken=='3', na.rm = TRUE)) %>% 
  mutate(derived_race = fct_reorder(derived_race, denied)) %>%  
  ggplot(aes(x=derived_race,y=denied, fill = derived_race))+
  geom_()+
  coord_flip()
  
```

```{r}
HMDA_selected %>% 
  group_by(derived_race) %>% 
  summarise(approved = sum(action_taken=='1', na.rm=TRUE)) %>% 
  mutate(derived_race = fct_reorder(derived_race, approved)) %>% 
  ggplot(aes(x=derived_race, y=approved, fill = derived_race))+
  geom_col()+
  coord_flip()
```


Next time: work on making these graphs a proportion of the derived race instead of a count of the loans. 
Also work on adding in derived ethnicity and transmuting a new column. 
Use a weighted mean and weight by population size
Also weight by bank size. 
I don't see a column for disability
Download the data for the PNW and send it in the slack group. Oregon, washington, Idaho




```{r}
HMDA_selected %>% 
  group_by(derived_race, debt_to_income_ratio) %>% 
  summarise(approved = sum(action_taken =='1', na.rm=TRUE)) %>% 
  mutate(derived_race = fct_reorder(derived_race, approved)) %>% 
  ggplot(aes(x=derived_race,y=approved, fill = derived_race))+
  geom_col()+
  coord_flip()

```
```{r}
correlation_df <-HMDA_selected %>%
  select(where(is.numeric)) %>%
  cor(x = HMDA_selected['tract_minority_population_percent'] , use = 'complete.obs') %>%
  as_tibble() %>%
  rownames_to_column() %>%
  pivot_longer(-rowname, 'class', 'cor') %>%
  arrange(desc(value))
```

```{r}
correlation_df %>%
  ggplot(aes(x = reorder(x= class, X = value), y = value, fill = (value < 0))) +
  geom_col() +
  coord_flip() +
  labs(title = "Corellations with ") +
  ylab("Correlation") +
  xlab("Variable")
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

