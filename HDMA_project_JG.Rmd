---
title: "HMDA_project_JG"
author: "James Gilbert"
date: "12/9/2021"
output: html_document
---

```{r}
library(httr)
library(tidyverse)
#library(jsonlite)
```

Don't run unless the API call does not work. 
```{r}
#HMDA_PNW<- read_csv('data/state_WA-OR-ID-MT.csv')
```


USE THIS CODE FOR API CALL FOR PNW. Add in Alaska or other years if needed. 
```{r}
url <- 'https://ffiec.cfpb.gov/v2/data-browser-api/view/csv?states=WA,MT,ID,OR&years=2020'

response <- GET(url)

HMDA_PNW<-content(response, as = "text") %>%
  read_csv()
```
```{r}
spec(HMDA_PNW)
```
I need to examine this and change data types to the correct ones. Should have already done this. 


```{r}
url_LEI <- 'https://ffiec.cfpb.gov/v2/data-browser-api/view/filers?states=WA,MT,ID,OR&years=2020'
response_PNW_LEI <- GET(url_LEI) 
lei_PNW <- content(response_PNW_LEI, type = 'text') %>% 
  jsonlite::fromJSON() %>% 
  .[[1]] %>%                      # Select the first element of the resulting list
  as_tibble()
```

Merge the LEI dataframe with the HMDA dataframe so we can correlate institution name with the LEI. 
```{r}
HMDA_PNW<- HMDA_PNW %>%
  left_join(x=HMDA_PNW, y =lei_PNW, by = 'lei')

```

```{r}
lei_PNW %>% 
  ggplot(aes(count))+
  geom_histogram(bins = 50)
```


Change number code columns to strings. 
```{r}
HMDA_PNW$action_taken <-recode(HMDA_PNW$action_taken,
             '1'= 'loan originated',
             '2'= 'application approved but not accepted',
             '3'= 'application denied',
             '4'= 'application withdrawn by applicant',
             '5'= 'file closed for incompleteness',
             '6'= 'purchased loan',
             '7'= 'preapproval request denied',
             '8'= 'preapproval request approved but not accepted'
             )

HMDA_PNW$loan_type <-recode(HMDA_PNW$loan_type,
                            '1' = 'Conventional (not insured or guaranteed by FHA, VA, RHS, or FSA)',
                            '2' = 'Federal Housing Administration insured (FHA)',
                            '3' = 'Veterans Affairs guaranteed (VA)',
                            '4' = 'USDA Rural Housing Service or Farm Service Agency guaranteed (RHS or FSA)'
                            )



HMDA_PNW$construction_method <- recode(HMDA_PNW$construction_method,
                                       '1' = 'Site-built',
                                       '2' = 'Manufactured home'
                                       )

HMDA_PNW$reverse_mortgage <- recode(HMDA_PNW$reverse_mortgage,
                                    '1' = 'Reverse mortgage',
                                    '2' = 'Not a reverse mortgage',
                                    '1111' = 'Exempt'
                                    )
HMDA_PNW$occupancy_type <- recode(HMDA_PNW$occupancy_type,
                                  '1' = 'Principal residence',
                                  '2' = 'Second residence',
                                  '3' = 'Investment property'
                                  )

HMDA_PNW$purchaser_type <-recode(HMDA_PNW$purchaser_type,
                                 '0' = 'Not applicable',
                                 '1' = 'Fannie Mae',
                                 '2' = 'Ginnie Mae',
                                 '3' = 'Freddie Mac',
                                 '4' = 'Farmer Mac',
                                 '5' = 'Private securitizer',
                                 '6' = 'Commercial bank, savings bank, or savings association',
                                 '71' ='Credit union, mortgage company, or finance company',
                                 '72' = 'Life insurance company',
                                 '8' = 'Affiliate institution',
                                 '9' = 'Other type of purchaser'                                
                                 )

HMDA_PNW$loan_purpose <- recode(HMDA_PNW$loan_purpose,
                                '1' = 'Home purchase',
                                '2' = 'Home improvement',
                                '31'= 'Refinancing',
                                '32'= 'Cash-out refinancing',
                                '4' = 'Other purpose',
                                '5' = 'Not applicable'
                                )
HMDA_PNW$`denial_reason-1`<- recode(HMDA_PNW$`denial_reason-1`,
       '1' = 'Debt-to-income ratio',
       '2' = 'Employment history',
       '3' = 'Credit history',
       '4' = 'Collateral',
       '5' = 'Insufficient cash (downpayment, closing costs)',
       '6' = 'Unverifiable information',
       '7' = 'Credit application incomplete',
       '8' = 'Mortgage insurance denied',
       '9' = 'Other'
       )

HMDA_PNW$`denial_reason-2`<- recode(HMDA_PNW$`denial_reason-2`,
       '1' = 'Debt-to-income ratio',
       '2' = 'Employment history',
       '3' = 'Credit history',
       '4' = 'Collateral',
       '5' = 'Insufficient cash (downpayment, closing costs)',
       '6' = 'Unverifiable information',
       '7' = 'Credit application incomplete',
       '8' = 'Mortgage insurance denied',
       '9' = 'Other'
       )

HMDA_PNW$`denial_reason-3`<- recode(HMDA_PNW$`denial_reason-3`,
       '1' = 'Debt-to-income ratio',
       '2' = 'Employment history',
       '3' = 'Credit history',
       '4' = 'Collateral',
       '5' = 'Insufficient cash (downpayment, closing costs)',
       '6' = 'Unverifiable information',
       '7' = 'Credit application incomplete',
       '8' = 'Mortgage insurance denied',
       '9' = 'Other'
       )
HMDA_PNW$`denial_reason-4`<- recode(as.numeric(HMDA_PNW$`denial_reason-4`),
       '1' = 'Debt-to-income ratio',
       '2' = 'Employment history',
       '3' = 'Credit history',
       '4' = 'Collateral',
       '5' = 'Insufficient cash (downpayment, closing costs)',
       '6' = 'Unverifiable information',
       '7' = 'Credit application incomplete',
       '8' = 'Mortgage insurance denied',
       '9' = 'Other'
       )

```


```{r}
lei_PNW %>% 
  select(name,count) %>% 
  top_n(5, count)
```

I want to begin exploring the data set by comparing the 'protected' classes from the HMDA

```{r}
HMDA_selected<- HMDA_PNW %>% 
  select(activity_year,lei,'derived_msa-md',state_code,county_code,census_tract,derived_loan_product_type,derived_dwelling_category,derived_ethnicity,derived_race,derived_sex,action_taken,purchaser_type,preapproval,loan_type,loan_purpose,lien_status,reverse_mortgage,loan_amount,loan_to_value_ratio,interest_rate,rate_spread,hoepa_status,total_loan_costs,total_points_and_fees,origination_charges,loan_term,property_value,construction_method,occupancy_type,manufactured_home_land_property_interest,total_units,income,debt_to_income_ratio,applicant_age,'co-applicant_age',applicant_age_above_62,'co-applicant_age_above_62','denial_reason-1','denial_reason-2','denial_reason-3','denial_reason-4',tract_population,tract_minority_population_percent,ffiec_msa_md_median_family_income,tract_to_msa_income_percentage,tract_owner_occupied_units,tract_one_to_four_family_homes,tract_median_age_of_housing_units)
```

```{r}
#HMDA_corr<- 
HMDA_selected %>%
  select(where(is.numeric)) %>% 
  cor(y= HMDA_selected['tract_minority_population_percent'], use = 'complete.obs') %>% 
  data.frame()
```

Trying to normalize the # of loans by population of the tract. 
```{r}
HMDA_selected %>% 
  select(derived_race, action_taken, tract_population) %>% 
  filter(action_taken==1, tract_population>0) %>% 
  group_by(derived_race) %>% 
  count() %>% 
  summarise(proportion = n/tract_population)
```  

```{r}
HMDA_selected %>% sum(HMDA_selected$action_taken == '1', na.rm = TRUE)
```


```{r}
HMDA_selected %>% 
  ggplot(aes(x = sum(action_taken), color = derived_sex)) +
  geom_boxplot()
```


```{r}
HMDA_selected %>% 
  group_by(derived_race) %>% 
  summarise(denied = sum(action_taken=='3', na.rm = TRUE)) %>% 
  mutate(derived_race = fct_reorder(derived_race, denied)) %>%  
  ggplot(aes(x=derived_race,y=denied, fill = derived_race))+
  geom_()+
  coord_flip()
  
```

```{r}
HMDA_selected %>% 
  group_by(derived_race) %>% 
  summarise(approved = sum(action_taken=='1', na.rm=TRUE)) %>% 
  mutate(derived_race = fct_reorder(derived_race, approved)) %>% 
  ggplot(aes(x=derived_race, y=approved, fill = derived_race))+
  geom_col()+
  coord_flip()
```


Next time: work on making these graphs a proportion of the derived race instead of a count of the loans. 
Use a weighted mean and weight by population size?
Also weight by bank size. 
I don't see a column for disability- there isn't one. Ignore this part of the MVP. 

```{r}
HMDA_selected %>% 
  group_by(derived_race, debt_to_income_ratio) %>% 
  summarise(approved = sum(action_taken =='1', na.rm=TRUE)) %>% 
  mutate(derived_race = fct_reorder(derived_race, approved)) %>% 
  ggplot(aes(x=derived_race,y=approved, fill = derived_race))+
  geom_col()+
  coord_flip()

```
```{r}
correlation_df <-HMDA_selected %>%
  select(where(is.numeric)) %>%
  cor(x = HMDA_selected['tract_minority_population_percent'] , use = 'complete.obs') %>%
  as_tibble() %>%
  rownames_to_column() %>%
  pivot_longer(-rowname, 'class', 'cor') %>%
  arrange(desc(value))
```

```{r}
correlation_df %>%
  ggplot(aes(x = reorder(x= class, X = value), y = value, fill = (value < 0))) +
  geom_col() +
  coord_flip() +
  labs(title = "Corellations with ") +
  ylab("Correlation") +
  xlab("Variable")
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

